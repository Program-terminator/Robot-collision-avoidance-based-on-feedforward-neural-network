# 智能避障机器人模拟系统

这是一个基于PyGame和PyTorch的智能避障机器人模拟系统，通过神经网络实现碰撞预测和智能导航功能。系统支持多种地图环境，用户可以通过点击指定目标点，机器人会自动规划路径并避开障碍物到达目标位置。

## 项目结构

```
pygame_collision/
├── data/
│   ├── predict/              # 碰撞预测热图结果
│   │   └── collision_prediction_heatmap_v*.png
│   └── train/                # 训练数据
│       └── sensor_data_v*.csv
├── model/
│   ├── model_enhanced.pth    # 增强版训练模型
│   └── train_model_enhanced.py  # 模型训练脚本
├── sim/
│   ├── map.py                # 地图定义文件
│   ├── test_heatmap_multiple.py  # 多地图碰撞热图测试
│   ├── train_multiple_maps.py    # 多地图数据采集
│   ├── robot_realtime_collision_avoidance_without_traget.py  # 无目标实时避障主程序
|   └── robot_realtime_collision_avoidance_with_traget.py  # 有目标实时避障主程序（用户可设置目标）
└── README.md
```

## 文件说明

### 1. 地图和环境

- **map.py**: 定义了不同版本的地图环境，包含障碍物的位置和大小。支持v1到v15多种地图布局。

### 2. 数据采集和训练

- **train_multiple_maps.py**: 在多种地图上采集传感器数据和碰撞标签，用于训练神经网络。
- **sensor_data_v*.csv**: 不同地图版本采集的传感器数据文件。
- **train_model_enhanced.py**: 训练神经网络模型，从传感器数据学习预测潜在碰撞。

### 3. 模型和预测

- **model.pth**: 基础版神经网络模型。
- **model_enhanced.pth**: 增强版神经网络模型，具有更好的预测性能。
- **test_heatmap_multiple.py**: 生成多地图版本的碰撞预测热图。
- **collision_prediction_heatmap_v*.png**: 不同地图的碰撞预测热图结果。

### 4. 实时避障应用

- **robot_realtime_collision_avoidance_without_target.py**: 主应用程序1，实现实时避障功能, 但无法设置目标，可用于模型能力调试。
- **robot_realtime_collision_avoidance_with_target.py**: 主应用程序2，实现实时避障功能，可设置目标，更符合真实应用。

## 使用步骤

说明：下面步骤为完整`采集数据（1）--训练模型（2）--测试模型（3/4）`流程   
if: 你想自己采集数据并训练，请按以下1-2-3/4步执行  
else: 你想使用笔者已经训练好的模型,请直接执行步骤4以快速可视化模型效果(训练好的模型已保存在`model/model_enhanced.pth`)

### 1. 数据采集

首先，需要在多种地图环境中采集传感器数据用于训练：

```bash
cd sim
python train_multiple_maps.py
```

这将在多个地图版本上随机移动机器人，采集传感器数据和碰撞标签，并保存到`data/train/`目录。

### 2. 模型训练

使用采集的数据训练神经网络模型：

```bash
cd model
python train_model_enhanced.py
```
注：可自行改变神经网络结构以测试不同结构的训练效果，但注意在演示主程序中做相应的修改  
训练完成后，模型将保存为`model/model_enhanced.pth`。

### 3. 碰撞热图测试

可以生成碰撞预测热图来可视化模型性能：

```bash
cd sim
python test_heatmap_multiple.py
```

热图结果保存在`data/predict/`目录下。

### 4. 实时避障演示

运行主程序进行实时避障演示：

```bash
cd sim
python robot_realtime_collision_avoidance_with_target.py  
#或使用 python robot_realtime_collision_avoidance_without_target.py  
```

注：    
1.可以在两个文件的超参数对应位置修改任意你想要测试的地图（具体地图见`sim/map.py`,其中已有22张地图可供选择，你也可以按照相应格式自行创建地图并使用），具体步骤如下：

```bash
MAP_VERSION = "v12" 
#修改示例： MAP_VERSION = "v13"  
```
2.在有目标演示程序`robot_realtime_collision_avoidance_with_target.py`中，可对相应的超参数进行修改测试效果。碰撞防护的超参数示例：
```bash
self.max_cache_size = 25  # 最大缓存步数
self.max_history = 50  # 最大历史路径点数量 
self.collision_threshold = 3  # 连续几次检测到碰撞触发强制反弹
self.max_retreat_attempts = 5  # 最大回退尝试次数
```


## 使用说明

在实时避障演示中：

- **鼠标点击**: 设置机器人目标点
- **空格键**: 暂停/继续模拟
- **R键**: 重置机器人位置
- **C键**: 清除当前目标点

## 技术实现

### 1. 感知与决策

- **传感器系统**: 使用32个虚拟传感器测量环境中的障碍物距离。
- **神经网络预测**: 基于PyTorch实现的前馈神经网络，通过传感器数据预测潜在碰撞。
- **实时决策**: 根据预测结果和目标位置动态调整机器人行进方向。

### 2. 导航与路径规划

- **目标导航**: 动态计算目标方向，平滑调整机器人朝向。
- **避障机制**: 当预测到潜在碰撞时，临时偏离原路径避开障碍物。
- **智能转向**: 根据目标位置和障碍物情况动态调整转向角度和速度。


### 3. 高级碰撞防护

- **动态路径缓存系统**: 维护机器人最近经过的路径点，用于紧急情况下的回退操作。
  - 短期路径缓存(path_cache): 用于紧急回退
  - 长期路径历史(path_history): 用于可视化
- **紧急返回机制**: 连续检测到多次碰撞风险时，执行多级回退策略：
  - 初始回退: 尝试回退少量步骤
  - 渐进回退: 如果初次回退仍处于危险，增加回退步数
  - 随机逃逸: 当多次回退失败时，执行大角度随机转向
- **碰撞鲁棒性**: 通过碰撞计数器跟踪连续碰撞风险，超过阈值触发紧急操作。

### 4. 动态路径规划与多策略切换

系统实现了多种路径规划策略，并能根据环境和碰撞情况动态切换：

- **水平优先**：先沿水平方向移动至目标的x坐标，再垂直移动至目标y坐标。
- **垂直优先**：先沿垂直方向移动至目标的y坐标，再水平移动至目标x坐标。
- **之字形（zigzag）**：在水平和垂直之间插入多个中间点，形成曲折路径，避开障碍物。
- **直接路径**：采用对角线直线前往目标。

在导航过程中，系统会根据碰撞检测结果自动切换路径规划策略：

- 若某一策略下连续多次碰撞（如连续8次），自动切换到下一个策略（如水平优先→垂直优先→之字形→直接路径）。
- 路径段若多次被判定为阻塞，则标记为不可用，重新规划路径。
- 在同一区域反复碰撞时，系统会尝试更激进的路径变化（如之字形或随机偏移）。
- 路径规划历史会记录每次策略及其成功/失败，优先采用最近成功的策略。

该机制大幅提升了机器人在复杂障碍环境下的鲁棒性和自适应能力。

### 5. 可视化系统

- **实时路径显示**: 显示机器人历史轨迹和缓存路径
- **状态指示器**: 通过颜色区分安全(蓝)、警告(黄)、碰撞(红)和紧急状态(橙)
- **传感器可视化**: 绘制传感器线，显示环境感知范围
- **紧急回退可视化**: 在紧急状态下显示回退目标点和尝试次数

## 系统需求

- Python 3.7+
- PyGame
- PyTorch
- NumPy

## 性能参数

- 机器人半径: 15像素
- 传感器数量: 32
- 传感器长度: 100像素
- 移动速度: 3.0像素/帧
- 目标到达阈值: 20像素
- 碰撞警报阈值: 连续3次检测到碰撞风险
- 最大回退尝试次数: 5次
- 路径缓存容量: 25步
